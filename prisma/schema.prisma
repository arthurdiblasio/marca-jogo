// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  // output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Sport {
  id          String @id @default(cuid())
  name        String @unique
  durationMin Int    @default(90)

  teams          Team[]
  categories     Category[]
  gameOffers     GameOffer[]
  recurringGames RecurringGame[]
  gameModalities GameModality[]
}

model GameModality {
  id            String  @id @default(uuid())
  name          String // ex: "Futebol 11", "Fut7", "Futsal"
  description   String? // detalhes para o usuário
  players       Int // jogadores totais ex: 11, 7, 6, 5
  onField       Int // jogadores na linha (excluindo goleiro)
  hasGoalkeeper Boolean @default(true)

  sportId String
  sport   Sport  @relation(fields: [sportId], references: [id])

  gameOffers GameOffer[]
  games      Game[]

  createdAt DateTime @default(now())
}

model Category {
  id      String @id @default(cuid())
  name    String
  sportId String

  sport          Sport           @relation(fields: [sportId], references: [id])
  teams          Team[]
  gameOffers     GameOffer[]
  recurringGames RecurringGame[]

  @@unique([sportId, name])
}

model User {
  id               String    @id @default(uuid())
  name             String
  email            String    @unique
  password         String
  phone            String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  isEmailVerified  Boolean   @default(false)
  verificationCode String?
  codeExpiresAt    DateTime?

  // relacionamento
  teams   Team[]
  Account Account[]
  Session Session[]
}

model Team {
  id           String     @id @default(uuid())
  name         String
  abbreviation String?
  logo         String?
  foundedAt    String?
  history      String?
  instagram    String?
  photos       String[]
  city         String?
  state        String?
  neighborhood String?
  latitude     Float?
  longitude    Float?
  hasField     Boolean    @default(false)
  fullAddress  String?
  gender       GameGender @default(MALE)
  fieldInfo    Json?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  ownerId String
  owner   User   @relation(fields: [ownerId], references: [id])

  sportId          String
  sport            Sport             @relation(fields: [sportId], references: [id])
  category         Category?         @relation(fields: [categoryId], references: [id])
  categoryId       String?
  players          PlayerInTeam[]
  homeGames        Game[]            @relation("HomeTeam")
  awayGames        Game[]            @relation("AwayTeam")
  gameOffers       GameOffer[]
  applicationsSent GameApplication[] @relation("ApplicationsByTeam")
  recurringGames   RecurringGame[]
  gameEvents       GameEvent[]
  gameTeamStats    GameTeamStats[]
  playerGameStats  PlayerGameStats[]

  @@unique([ownerId, name, sportId])
}

model Player {
  id       String  @id @default(uuid())
  name     String
  nickname String?
  photo    String?

  teams  PlayerInTeam[]
  stats  PlayerGameStats[]
  events GameEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PlayerInTeam {
  id String @id @default(uuid())

  playerId String
  player   Player @relation(fields: [playerId], references: [id])

  teamId String
  team   Team   @relation(fields: [teamId], references: [id])

  joinedAt DateTime  @default(now())
  leftAt   DateTime?
}

model GameOffer {
  id String @id @default(uuid())

  teamId String
  team   Team   @relation(fields: [teamId], references: [id])

  sportId String
  sport   Sport  @relation(fields: [sportId], references: [id])

  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id])

  type GameType @default(AMISTOSO)

  gender GameGender @default(MALE)

  gameDate    DateTime
  durationMin Int

  fieldAddress String
  latitude     Float?
  longitude    Float?

  fee         Float?
  includesRef Boolean
  refereeType RefereeType?

  status GameOfferStatus @default(OPEN)

  applications GameApplication[]
  game         Game?
  modalityId   String?
  modality     GameModality?     @relation(fields: [modalityId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([gameDate])
  @@index([sportId])
  @@index([modalityId])
  @@index([gender])
  @@index([categoryId])
  @@index([status])
  @@index([sportId, modalityId, gender])
  @@index([sportId, modalityId, gender, gameDate])
}

enum GameGender {
  MALE // masculino
  FEMALE // feminino
  MIXED // misto
}

enum GameOfferStatus {
  OPEN
  PENDING
  CONFIRMED
  CANCELED
  EXPIRED
  PLAYED
}

enum GameType {
  AMISTOSO
  FESTIVAL
  CAMPEONATO
}

enum RefereeType {
  SOLO
  TRIO
}

model GameApplication {
  id String @id @default(uuid())

  offerId String
  offer   GameOffer @relation(fields: [offerId], references: [id])

  applicantTeamId String
  applicantTeam   Team   @relation("ApplicationsByTeam", fields: [applicantTeamId], references: [id])

  message String?
  status  ApplicationStatus @default(PENDING)

  createdAt DateTime @default(now())
}

enum ApplicationStatus {
  PENDING
  ACCEPTED
  REJECTED
}

model Game {
  id String @id @default(uuid())

  offerId String    @unique
  offer   GameOffer @relation(fields: [offerId], references: [id])

  homeTeamId String
  homeTeam   Team   @relation("HomeTeam", fields: [homeTeamId], references: [id])

  awayTeamId String
  awayTeam   Team   @relation("AwayTeam", fields: [awayTeamId], references: [id])

  homeScore Int?
  awayScore Int?

  startedAt  DateTime?
  finishedAt DateTime?

  events      GameEvent[]
  teamStats   GameTeamStats[]
  playerStats PlayerGameStats[]
  gender      GameGender

  createdAt  DateTime      @default(now())
  modalityId String?
  modality   GameModality? @relation(fields: [modalityId], references: [id])
}

model GameEvent {
  id String @id @default(uuid())

  gameId String
  game   Game   @relation(fields: [gameId], references: [id])

  teamId String
  team   Team   @relation(fields: [teamId], references: [id])

  playerId String
  player   Player @relation(fields: [playerId], references: [id])

  minute Int?
  type   EventType
  value  Float?

  createdAt DateTime @default(now())
}

enum EventType {
  GOAL
  ASSIST
  YELLOW
  RED
  RATING
}

model GameTeamStats {
  id String @id @default(uuid())

  gameId String
  game   Game   @relation(fields: [gameId], references: [id])

  teamId String
  team   Team   @relation(fields: [teamId], references: [id])

  isHome Boolean

  goals        Int
  goalsAgainst Int
  result       GameResult

  createdAt DateTime @default(now())
}

enum GameResult {
  WIN
  DRAW
  LOSS
}

model PlayerGameStats {
  id String @id @default(uuid())

  gameId String
  game   Game   @relation(fields: [gameId], references: [id])

  playerId String
  player   Player @relation(fields: [playerId], references: [id])

  teamId String
  team   Team   @relation(fields: [teamId], references: [id])

  goals   Int    @default(0)
  assists Int    @default(0)
  yellow  Int    @default(0)
  red     Int    @default(0)
  rating  Float?

  shirtNumber Int?

  createdAt DateTime @default(now())
}

model RecurringGame {
  id String @id @default(uuid())

  teamId String
  team   Team   @relation(fields: [teamId], references: [id])

  weekday     Int // 0=domingo ... 6=sábado
  time        String // "10:00"
  durationMin Int

  sportId String
  sport   Sport  @relation(fields: [sportId], references: [id])

  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id])

  weeksAhead Int?
  untilDate  DateTime?

  status RecurringStatus @default(PENDING)
  notes  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum RecurringStatus {
  PENDING
  GENERATING
  COMPLETED
  PAUSED
  CANCELED
}

model FieldSurfaceTypes {
  id   String @id @default(cuid())
  name String @unique
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
